# Диагностика проблем с Next.js сервером

## Возможные причины падения сервера:

### 1. Ограничения shared хостинга Beget
- Процессы могут убиваться после периода неактивности
- Ограничения по памяти
- Ограничения по времени работы процессов

### 2. Ошибки в приложении
- Необработанные исключения
- Утечки памяти
- Проблемы с подключениями к БД или API

### 3. Проблемы с PM2
- PM2 не запускается автоматически после перезагрузки
- Неправильные настройки автоперезапуска

## Команды для диагностики:

```bash
# Проверить статус PM2
pm2 status

# Посмотреть детальную информацию
pm2 describe nextjs-qwertysb

# Посмотреть логи
pm2 logs nextjs-qwertysb --lines 100

# Посмотреть логи ошибок
pm2 logs nextjs-qwertysb --err --lines 100

# Проверить использование памяти
pm2 monit

# Проверить, отвечает ли сервер
curl http://127.0.0.1:4000/

# Проверить, какие процессы слушают порт 4000
lsof -i :4000
```

## Решения:

### Если сервер падает из-за нехватки памяти:
- Уменьшите `max_memory_restart` в `ecosystem.config.js`
- Оптимизируйте код приложения

### Если сервер падает из-за ошибок:
- Проверьте логи: `pm2 logs nextjs-qwertysb --err`
- Исправьте ошибки в коде

### Если PM2 не запускается автоматически:
- Запустите вручную: `pm2 start ecosystem.config.js`
- Сохраните конфигурацию: `pm2 save`

### Если процессы убиваются системой:
- Это ограничение shared хостинга
- Рассмотрите возможность использования VPS или выделенного сервера
- Или используйте внешний сервис для мониторинга и перезапуска

## Мониторинг:

Скрипт `check_and_restart.sh` можно запускать вручную для проверки:
```bash
/home/q/qwertysb/qwertysb.beget.tech/popkov_site/check_and_restart.sh
```

Если cron недоступен, можно настроить внешний мониторинг (например, UptimeRobot) который будет делать запросы к сайту и уведомлять о проблемах.
